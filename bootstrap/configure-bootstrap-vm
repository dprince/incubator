#!/usr/bin/env python

import argparse
import os.path

import libvirt

basedir = os.path.dirname(__file__)

def main():
    parser = argparse.ArgumentParser(
        description="Configure a kvm virtual machine for the bootstrap image.")
    parser.add_argument('--name', default='bootstrap',
        help='the name to give the machine in libvirt.')
    parser.add_argument('--image',
        help='Use a custom image file (must be qcow2).')
    parser.add_argument('--baremetal-interface', default='br99',
        help='The interface which bare metal nodes will be connected to.')
    parser.add_argument('--engine', default='kvm',
        help='The virtualization engine to use')
    parser.add_argument('--emulator', default='',
        help='The virtualization emulator to use')
    args = parser.parse_args()
    with file(basedir + '/bootstrap.xml', 'rb') as f:
        source_template = f.read()
    imagefile = '/var/lib/libvirt/images/bootstrap.qcow2'
    if args.image:
        imagefile = args.image
    imagefile = os.path.realpath(imagefile)
    params = {
        'name': args.name,
        'imagefile': imagefile,
        'bmbridge': args.baremetal_interface,
        'engine': args.engine,
        'emulator': args.emulator
        }
    if args.image is not None:
        params['imagefile'] = args.image

    if args.emulator == '':
        if os.path.exists("/usr/bin/kvm"): # Debian
            params['emulator'] = "/usr/bin/kvm"
        elif os.path.exists("/usr/bin/qemu-kvm"): # Redhat
            params['emulator'] = "/usr/bin/qemu-kvm"

    libvirt_template = source_template % params
    conn=libvirt.open("qemu:///system")
    a = conn.defineXML(libvirt_template)
    print ("Created machine %s with UUID %s" % (args.name, a.UUIDString()))

if __name__ == '__main__':
    main()

